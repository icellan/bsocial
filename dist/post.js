"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_ecies=_interopRequireDefault(require("bsv/ecies")),_constants=require("./constants"),BSocialPost=function(){function a(b){if((0,_classCallCheck2["default"])(this,a),!b)throw new Error("App name needs to be set");this.appName=b,this.type="post",this.txId="",this.texts=[],this.images=[],this.paywallMessage="",this.paywallType="text/markdown",this.paywallKey=null,this.paywallCurrency="USD",this.paywallPayouts="",this.paywallServer="",this.extraMapData={}}return(0,_createClass2["default"])(a,[{key:"setType",value:function setType(a){this.type=a}},{key:"setTxId",value:function setTxId(a){this.txId=a}},{key:"setPaywall",value:function setPaywall(a,b,c,d,e){this.paywallMessage=a,this.paywallKey=b,this.paywallPayouts=c,this.paywallServer=d,this.paywallCurrency=e}},{key:"setPaywallType",value:function setPaywallType(a){this.paywallType=a}},{key:"addMapData",value:function addMapData(a,b){if("string"!=typeof a||"string"!=typeof b)throw new Error("Key and value should be a string");this.extraMapData[a]=b}},{key:"addText",value:function addText(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"text/markdown";if("string"!=typeof a)throw new Error("Text should be a string");this.texts.push({text:a,type:b})}},{key:"addMarkdown",value:function addMarkdown(a){this.addText(a)}},{key:"addImage",value:function addImage(a){var b=a.split(","),c=b[0].split(";"),d=c[0].split(":");if("data"!==d[0]||"base64"!==c[1]||!d[1].match("image/"))throw new Error("Invalid image dataUrl format");this.images.push({content:Buffer.from(b[1],"base64"),type:d[1]})}},{key:"getOps",value:function getOps(){var a=this,b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"hex",c=0<this.texts.length||0<this.images.length,d="repost"===this.type&&this.txId;if(!c&&!d)throw new Error("There is no content for this post");var e=[];if(0<this.texts.length&&this.texts.forEach(function(a){e.push(_constants.B_PROTOCOL_ADDRESS),e.push(a.text),e.push(a.type),e.push("UTF-8"),e.push("|")}),this.paywallMessage&&this.paywallKey){var g=new _ecies["default"];g.publicKey(this.paywallKey.toPublicKey());var h=g.encrypt(this.paywallMessage).toString("base64");e.push(_constants.B_PROTOCOL_ADDRESS),e.push(h),e.push("application/bitcoin-ecies; content-type=\"".concat(this.paywallType,"\"")),e.push("UTF-8"),e.push("|"),e.push(_constants.BPP_PROTOCOL_ADDRESS),e.push("PAY"),e.push(this.paywallCurrency),e.push(this.paywallPayouts),e.push(this.paywallServer),e.push("|")}0<this.images.length&&this.images.forEach(function(a){e.push(_constants.B_PROTOCOL_ADDRESS),e.push(a.content),e.push(a.type),e.push("|")}),e.push(_constants.MAP_PROTOCOL_ADDRESS),e.push("SET"),e.push("app"),e.push(this.appName),e.push("type"),e.push(this.type),this.txId&&("repost"!==this.type&&(e.push("context"),e.push("tx")),e.push("tx"),e.push(this.txId));var f=Object.keys(this.extraMapData);return f.length&&f.forEach(function(b){e.push(b),e.push(a.extraMapData[b])}),e.map(function(a){return(Buffer.isBuffer(a)?a:Buffer.from(a)).toString(b)})}}]),a}(),_default=BSocialPost;exports["default"]=_default;